"use strict";(self.webpackChunkseahub_frontend=self.webpackChunkseahub_frontend||[]).push([[514],{67145:function(e,n,t){var i=t(15671),s=t(43144),o=t(60136),r=t(29388),a=t(72791),c=t(53585),l=t(95996),h=t(51832),d=t(80184),u=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).onClick=function(e){s.inputRef.current.contains(e.target)||s.onRenameConfirm()},s.onChange=function(e){s.setState({name:e.target.value})},s.onKeyDown=function(e){e.keyCode===l.c.keyCodes.enter?s.onRenameConfirm(e):e.keyCode===l.c.keyCodes.esc&&s.onRenameCancel(e),e.nativeEvent.stopImmediatePropagation()},s.onRenameConfirm=function(e){e&&e.nativeEvent.stopImmediatePropagation();var n=s.state.name.trim();if(n!==s.props.name){var t=s.validateInput(),i=t.isValid,o=t.errMessage;i?s.props.onRenameConfirm(n):(h.Z.danger(o),s.props.onRenameCancel())}else s.props.onRenameCancel()},s.onRenameCancel=function(e){e.nativeEvent.stopImmediatePropagation(),s.props.onRenameCancel()},s.validateInput=function(){var e=s.state.name.trim(),n=!0,t="";return e?e.indexOf("/")>-1?{isValid:n=!1,errMessage:t=(0,c.ih)("Name should not include '/'.")}:{isValid:n,errMessage:t}:{isValid:n=!1,errMessage:t=(0,c.ih)("Name is required.")}},s.state={name:e.name},s.inputRef=a.createRef(),s}return(0,s.Z)(t,[{key:"componentDidMount",value:function(){var e=this;if(this.inputRef.current.focus(),this.props.hasSuffix){var n=this.props.name.lastIndexOf(".");this.inputRef.current.setSelectionRange(0,n,"forward")}else this.inputRef.current.setSelectionRange(0,-1);setTimeout((function(){document.addEventListener("click",e.onClick)}),1)}},{key:"componentWillUnmount",value:function(){document.removeEventListener("click",this.onClick)}},{key:"render",value:function(){return(0,d.jsx)("div",{className:"rename-container",children:(0,d.jsx)("input",{ref:this.inputRef,value:this.state.name,onChange:this.onChange,onKeyDown:this.onKeyDown})})}}]),t}(a.Component);n.Z=u},95558:function(e,n,t){var i=t(15671),s=t(43144),o=t(60136),r=t(29388),a=t(72791),c=t(54164),l=t(98290),h=t(81694),d=t.n(h),u=t(70267),f=t(22228),m=t(53585),g=t(63446),p=t(80184),v=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(){var e;(0,i.Z)(this,t);for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return(e=n.call.apply(n,[this].concat(o))).onBackClick=function(e){e.preventDefault(),window.history.back()},e}return(0,s.Z)(t,[{key:"render",value:function(){return(0,p.jsx)("div",{className:"go-back",onClick:this.onBackClick,children:(0,p.jsx)("span",{className:"fas fa-chevron-left"})})}}]),t}(a.Component),y=v,x=t(93433),C=t(29439),w=t(72426),S=t.n(w),j=t(95996),V=t(39571),D=t(51832),Z=t(61599),N=t(20387),R=t(59508),I=t(52919),M=t(69498),H=t(67145);t(45020);S().locale(window.app.config.lang);var k=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).onMouseEnter=function(){var e=s.props,n=e.currentVersion,t=e.historyVersion;n.commit_id!==t.commit_id&&s.setState({isShowOperationIcon:!0})},s.onMouseLeave=function(){var e=s.props,n=e.currentVersion,t=e.historyVersion;n.commit_id!==t.commit_id&&s.setState({isShowOperationIcon:!1})},s.onToggleClick=function(e){s.setState({isMenuShow:!s.state.isMenuShow})},s.onClick=function(){s.setState({isShowOperationIcon:!1});var e=s.props,n=e.currentVersion,t=e.historyVersion,i=e.path;n.commit_id!==t.commit_id&&s.props.onSelectHistoryVersion(i)},s.onRestore=function(){var e=s.props.historyVersion;s.props.onRestore(e)},s.onItemDownload=function(){},s.onItemCopy=function(){var e=s.props.historyVersion;e.ctime_format=S()(e.ctime).format("YYYY-MM-DD HH:mm"),s.props.onCopy(e)},s.toggleRename=function(){s.setState({isRenameShow:!s.state.isRenameShow})},s.onRenameConfirm=function(e){var n=s.props.historyVersion.obj_id;s.props.renameHistoryVersion(n,e),s.toggleRename()},s.onRenameCancel=function(){s.toggleRename()},s.showDailyHistory=function(e){e.stopPropagation(),e.nativeEvent.stopImmediatePropagation();var n=s.props.path;s.props.showDailyHistory(n,(function(){s.props.onSelectHistoryVersion(n)}))},s.state={isShowOperationIcon:!1,isMenuShow:!1,isRenameShow:!1},s}return(0,s.Z)(t,[{key:"render",value:function(){var e=this.props,n=e.currentVersion,t=e.historyVersion,i=e.path,s=e.showDaily;if(!n||!t)return null;var o=t.ctime,r=t.commit_id,a=t.creator_name,c=t.obj_id,l=t.name,h=t.count,u=r===n.commit_id,f=M.Z.getUrl({type:"download_historic_file",filePath:m.bc,objID:c});return(0,p.jsxs)("li",{className:"history-list-item ".concat(u?"item-active":""," ").concat(i[2]>0?"daily-history-detail":""),onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onClick:this.onClick,children:[0===i[2]&&(0,p.jsx)("div",{className:"daily-history-detail-toggle-container",children:h>1&&(0,p.jsx)("div",{className:d()("daily-history-detail-toggle",{"daily-history-detail-show":s}),onClick:this.showDailyHistory,children:(0,p.jsx)("i",{className:"dropdown-toggle"})})}),i[2]>0&&(0,p.jsx)("div",{className:"daily-history-detail-no-more"}),(0,p.jsxs)("div",{className:"history-info",children:[this.state.isRenameShow?(0,p.jsx)(H.Z,{name:l,onRenameConfirm:this.onRenameConfirm,onRenameCancel:this.onRenameCancel}):(0,p.jsx)("div",{className:"name",children:l}),(0,p.jsx)("div",{className:"time",children:S()(o).format("YYYY-MM-DD HH:mm")}),(0,p.jsxs)("div",{className:"owner",children:[(0,p.jsx)("span",{className:"squire-icon"}),(0,p.jsx)("span",{children:a})]})]}),(0,p.jsx)("div",{className:"history-operation",children:(0,p.jsxs)(Z.Z,{isOpen:this.state.isMenuShow,toggle:this.onToggleClick,children:[(0,p.jsx)(N.Z,{tag:"a",className:"fas fa-ellipsis-v ".concat(this.state.isShowOperationIcon||u?"":"invisible"),"data-toggle":"dropdown","aria-expanded":this.state.isMenuShow,alt:(0,m.ih)("More Operations")}),(0,p.jsxs)(R.Z,{children:[(0,p.jsx)(I.Z,{tag:"a",href:f,onClick:this.onItemDownLoad,children:(0,m.ih)("Download")}),0!==i[0]&&0!==i[1]&&0!==i[2]&&(0,p.jsx)(I.Z,{onClick:this.onItemCopy,children:(0,m.ih)("Copy")}),(0,p.jsx)(I.Z,{onClick:this.toggleRename,children:(0,m.ih)("Rename")})]})]})})]})}}]),t}(a.Component),L=t(57786);S().locale(window.app.config.lang);var Y=window.fileHistory.pageOptions.docUuid,_=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;return(0,i.Z)(this,t),(s=n.call(this,e)).loadMore=function(){s.state.isReloadingData||(s.currentPage=s.currentPage+1,s.setState({isReloadingData:!0},(function(){f.I.listSdocHistory(Y,s.currentPage,m.LZ).then((function(e){s.updateResultState(e.data),s.setState({isReloadingData:!1})}))})))},s.renameHistoryVersion=function(e,n){f.I.renameSdocHistory(Y,e,n).then((function(t){s.setState({historyGroups:s.state.historyGroups.map((function(t){return t.obj_id==e&&(t.name=n),t}))})})).catch((function(e){var n=j.c.getErrorMsg(e,!0);s.setState({isLoading:!1,errorMessage:n})}))},s.onScrollHandler=function(e){var n=e.target.clientHeight,t=e.target.scrollHeight;n+e.target.scrollTop+1>=t&&s.state.hasMore&&s.loadMore()},s.restoreVersion=function(e){var n=e.commit_id,t=e.path;V.Z.revertFile(t,n).then((function(e){e.data.success&&s.setState({isLoading:!0},(function(){s.firstLoadSdocHistory()}));var n=(0,m.ih)("Successfully restored.");D.Z.success(n)})).catch((function(e){var n=j.c.getErrorMsg(e,!0);D.Z.danger((0,m.ih)(n))}))},s.getLastVersion=function(e,n){var t=s.state.historyGroups,i=(0,C.Z)(e,3),o=i[0],r=i[1],a=i[2],c=t[o],l=c.children[r],h="";if(n){var d,u,f;if(l.showDaily&&(h=l.children[a+1]),!h)h=null===(d=c.children[r+1])||void 0===d?void 0:d.children[0];if(!h)h=null===(u=t[o+1])||void 0===u||null===(f=u.children[0])||void 0===f?void 0:f.children[0];0!==o||h||(h="init")}return h},s.onSelectHistoryVersion=function(e){var n=s.state.historyGroups,t=s.props.isShowChanges,i=(0,C.Z)(e,3),o=i[0],r=i[1],a=i[2],c=n[o].children[r].children[a],l=s.getLastVersion(e,t);s.props.onSelectHistoryVersion(c,l)},s.copyHistoryFile=function(e){var n=e.path,t=e.obj_id,i=e.ctime_format;f.I.sdocCopyHistoryFile(m.y8,n,t,i).then((function(e){var n=(0,m.ih)("Successfully copied %(name)s."),t=e.data.file_name;n=n.replace("%(name)s",t),D.Z.success(n)})).catch((function(e){var n=j.c.getErrorMsg(e,!0);D.Z.danger((0,m.ih)(n))}))},s.showDailyHistory=function(e,n){var t=s.state.historyGroups.slice(0),i=t[e[0]].children[e[1]];return i.showDaily?(i.showDaily=!1,void s.setState({historyGroups:t},(function(){n&&n()}))):i.children.length>1?(i.showDaily=!0,void s.setState({historyGroups:t},(function(){n&&n()}))):void f.I.listSdocDailyHistoryDetail(Y,i.children[0].ctime).then((function(e){var o,r=e.data.histories;(o=i.children).push.apply(o,(0,x.Z)(r)),i.showDaily=!0,s.setState({historyGroups:t},(function(){n&&n()}))})).catch((function(e){var n=j.c.getErrorMsg(e,!0);D.Z.danger((0,m.ih)(n))}))},s.renderHistoryVersions=function(){var e=s.state,n=e.isLoading,t=e.historyGroups,i=e.errorMessage;return 0===t.length?n?(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center",children:(0,p.jsx)(g.Z,{})}):i?(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center error-message",children:(0,m.ih)(i)}):(0,p.jsx)("div",{className:"h-100 w-100 d-flex align-items-center justify-content-center empty-tip-color",children:(0,m.ih)("No version history")}):(0,p.jsxs)(p.Fragment,{children:[t.map((function(e,n){return(0,p.jsxs)(a.Fragment,{children:[(0,p.jsx)("div",{className:"history-list-item history-month-title",children:e.month},e.month),e.children.map((function(e,t){var i=e.children,o=e.showDaily;return(o?i:i.slice(0,1)).map((function(e,i){return(0,p.jsx)(k,{path:[n,t,i],showDaily:0===i&&o,currentVersion:s.props.currentVersion,historyVersion:e,onSelectHistoryVersion:s.onSelectHistoryVersion,onRestore:s.restoreVersion,onCopy:s.copyHistoryFile,renameHistoryVersion:s.renameHistoryVersion,showDailyHistory:s.showDailyHistory},e.commit_id)}))})).flat()]},e.month)})),n&&(0,p.jsx)("div",{className:"loading-more d-flex align-items-center justify-content-center w-100",children:(0,p.jsx)(g.Z,{})})]})},s.onShowChanges=function(){var e,n=s.props,t=n.isShowChanges,i=n.currentVersion,o=s.state.historyGroups,r=!t;if(r){var a=i.date,c=S()(a),l=c.format("YYYY-MM"),h=c.format("YYYY-MM-DD"),d=o.findIndex((function(e){return e.month===l})),u=o[d].children.findIndex((function(e){return e.day===h})),f=[d,u,o[d].children[u].children.findIndex((function(e){return e.date===a}))];e=s.getLastVersion(f,r)}s.props.onShowChanges(r,e)},s.state={isLoading:!0,historyGroups:[],errorMessage:"",hasMore:!1,isReloadingData:!1},s.currentPage=1,s}return(0,s.Z)(t,[{key:"componentDidMount",value:function(){this.firstLoadSdocHistory()}},{key:"firstLoadSdocHistory",value:function(){var e=this;this.currentPage=1,f.I.listSdocHistory(Y,this.currentPage,m.LZ).then((function(n){var t=n.data,i=t.histories.length,s=e.formatHistories(t.histories);e.setState({historyGroups:e.formatHistories(t.histories),hasMore:i>=m.LZ,isLoading:!1},(function(){s.length>0&&e.onSelectHistoryVersion([0,0,0])}))})).catch((function(n){throw e.setState({isLoading:!1}),Error("there has an error in server")}))}},{key:"formatHistories",value:function(e){var n=this.state.historyGroups;if(!Array.isArray(e)||0===e.length)return n;var t=n.slice(0);return e.forEach((function(e){var n=e.date,i=S()(n),s=i.format("YYYY-MM"),o=t.find((function(e){return e.month===s}));o?o.children.push({day:i.format("YYYY-MM-DD"),showDaily:!1,children:[e]}):t.push({month:s,children:[{day:i.format("YYYY-MM-DD"),showDaily:!1,children:[e]}]})})),t}},{key:"updateResultState",value:function(e){var n=e.histories.length;this.setState({historyGroups:this.formatHistories(e.histories),hasMore:n>=m.LZ,isLoading:!1})}},{key:"render",value:function(){var e=this.state.historyGroups;return(0,p.jsxs)("div",{className:"sdoc-file-history-panel h-100 o-hidden d-flex flex-column",children:[(0,p.jsx)("div",{className:"sdoc-file-history-select-range",children:(0,p.jsx)("div",{className:"sdoc-file-history-select-range-title",children:(0,m.ih)("History Versions")})}),(0,p.jsx)("div",{className:d()("sdoc-file-history-versions",{"o-hidden":0===e.length}),onScroll:this.onScrollHandler,children:this.renderHistoryVersions()}),(0,p.jsx)("div",{className:"sdoc-file-history-diff-switch d-flex align-items-center",children:(0,p.jsx)(L.Z,{checked:this.props.isShowChanges,placeholder:(0,m.ih)("Show changes"),className:"sdoc-history-show-changes w-100",size:"small",onChange:this.onShowChanges})})]})}}]),t}(a.Component),E=(t(28421),window.app.config),b=E.serviceURL,P=E.avatarURL,G=E.siteRoot,O=window.app.pageOptions,T=O.username,U=O.name,F=window.fileHistory.pageOptions,B=F.repoID,A=F.fileName,q=F.filePath,K=F.docUuid,z=F.assetsUrl;window.seafile={repoID:B,docPath:q,docName:A,docUuid:K,isOpenSocket:!1,serviceUrl:b,name:U,username:T,avatarURL:P,siteRoot:G,assetsUrl:z};var W=function(e){(0,o.Z)(t,e);var n=(0,r.Z)(t);function t(e){var s;(0,i.Z)(this,t),(s=n.call(this,e)).getInitContent=function(e){return e?{version:-1,children:[{id:e.id,type:"title",children:[{id:e.children[0].id,text:""}]}]}:s.getInitContentByPath()},s.getInitContentByPath=function(e){var n,t;return{version:-1,children:[{id:"1",type:"title",children:[{id:"2",text:e?null===(n=e.split("/"))||void 0===n||null===(t=n.pop())||void 0===t?void 0:t.slice(0,-5):""}]}]}},s.updateLastVersionContent=function(e,n,t){if(t)if("init"!==t)f.I.getFileRevision(m.y8,t.commit_id,t.path).then((function(e){return e.data?f.I.getFileContent(e.data):{data:""}})).then((function(n){var i=n.data,o=e.children[0],r=t&&!i?s.getInitContent(o):i;s.setContent(e,r)})).catch((function(n){var t=j.c.getErrorMsg(n,!0);D.Z.danger((0,m.ih)(t)),s.setContent(e,"")}));else{var i=e?s.getInitContent(e.children[0]):s.getInitContentByPath(n.path),o=e||s.getInitContentByPath(n.path);s.setContent(o,i)}else s.setContent(e,"")},s.onSelectHistoryVersion=function(e,n){s.setState({isLoading:!0,currentVersion:e}),f.I.getFileRevision(m.y8,e.commit_id,e.path).then((function(e){return f.I.getFileContent(e.data)})).then((function(t){var i=t.data;s.updateLastVersionContent(i,e,n)})).catch((function(e){var n=j.c.getErrorMsg(e,!0);D.Z.danger((0,m.ih)(n)),s.setContent("","")}))},s.setContent=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";s.setState({currentVersionContent:e,lastVersionContent:n,isLoading:!1,changes:[],currentDiffIndex:0})},s.onShowChanges=function(e,n){if(e){var t=s.state,i=t.currentVersionContent,o=t.currentVersion;s.setState({isLoading:!0,isShowChanges:e},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+""),s.updateLastVersionContent(i,o,n)}))}else s.setState({isLoading:!0,isShowChanges:e},(function(){s.setState({isLoading:!1,lastVersionContent:""},(function(){localStorage.setItem("seahub-sdoc-history-show-changes",e+"")}))}))},s.setDiffCount=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{value:[],changes:[]}).changes;s.setState({changes:e,currentDiffIndex:0})},s.jumpToElement=function(e){s.setState({currentDiffIndex:e},(function(){var e=s.state,n=e.currentDiffIndex,t=e.changes[n],i=document.querySelectorAll("[data-id=".concat(t,"]"))[0];i&&(s.historyContentRef.scrollTop=i.offsetTop-10)}))},s.lastChange=function(){var e=s.state,n=e.currentDiffIndex,t=e.changes;0!==n?s.jumpToElement(n-1):s.jumpToElement(t.length-1)},s.nextChange=function(){var e=s.state,n=e.currentDiffIndex;n!==e.changes.length-1?s.jumpToElement(n+1):s.jumpToElement(0)},s.renderChangesTip=function(){var e=s.state,n=e.isShowChanges,t=e.changes,i=e.currentDiffIndex;if(e.isLoading)return null;if(!n)return null;var o=t?t.length:0;return 0===o?(0,p.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:(0,p.jsx)("div",{className:"sdoc-file-changes-container d-flex align-items-center pl-2 pr-2",children:(0,m.ih)("No changes")})}):(0,p.jsx)("div",{className:"sdoc-file-history-header-right d-flex align-items-center",children:(0,p.jsxs)("div",{className:"sdoc-file-changes-container d-flex align-items-center",children:[(0,p.jsx)("div",{className:"sdoc-file-changes-tip d-flex align-items-center justify-content-center pl-2 pr-2",children:"".concat((0,m.ih)("Changes")," ").concat(i+1,"/").concat(o)}),(0,p.jsx)("div",{className:"sdoc-file-changes-divider"}),(0,p.jsx)("div",{className:"sdoc-file-changes-last d-flex align-items-center justify-content-center",id:"sdoc-file-changes-last",onClick:s.lastChange,children:(0,p.jsx)("span",{className:"fas fa-chevron-up"})}),(0,p.jsx)("div",{className:"sdoc-file-changes-divider"}),(0,p.jsx)("div",{className:"sdoc-file-changes-next d-flex align-items-center justify-content-center",id:"sdoc-file-changes-next",onClick:s.nextChange,children:(0,p.jsx)("span",{className:"fas fa-chevron-down"})}),(0,p.jsx)(l.Z,{placement:"bottom",target:"sdoc-file-changes-last",delay:0,fade:!1,children:(0,m.ih)("Last modification")}),(0,p.jsx)(l.Z,{placement:"bottom",target:"sdoc-file-changes-next",delay:0,fade:!1,children:(0,m.ih)("Next modification")})]})})};var o="false"!==localStorage.getItem("seahub-sdoc-history-show-changes");return s.state={isLoading:!0,isShowChanges:o,currentVersion:{},currentVersionContent:"",lastVersionContent:"",changes:[],currentDiffIndex:0},s}return(0,s.Z)(t,[{key:"render",value:function(){var e=this,n=this.state,t=n.currentVersion,i=n.isShowChanges,s=n.currentVersionContent,o=n.lastVersionContent,r=n.isLoading;return(0,p.jsxs)("div",{className:"sdoc-file-history d-flex h-100 w-100 o-hidden",children:[(0,p.jsxs)("div",{className:"sdoc-file-history-container d-flex flex-column",children:[(0,p.jsxs)("div",{className:"sdoc-file-history-header pt-2 pb-2 pl-4 pr-4 d-flex justify-content-between w-100 o-hidden",children:[(0,p.jsxs)("div",{className:d()("sdoc-file-history-header-left d-flex align-items-center o-hidden",{"pr-4":i}),children:[(0,p.jsx)(y,{}),(0,p.jsx)("div",{className:"file-name text-truncate",children:A})]}),this.renderChangesTip()]}),(0,p.jsx)("div",{className:"sdoc-file-history-content f-flex flex-column",ref:function(n){return e.historyContentRef=n},children:r?(0,p.jsx)("div",{className:"sdoc-file-history-viewer d-flex align-items-center justify-content-center",children:(0,p.jsx)(g.Z,{})}):(0,p.jsx)(u.ZX,{currentContent:s,lastContent:i?o:"",didMountCallback:this.setDiffCount})})]}),(0,p.jsx)(_,{isShowChanges:i,currentVersion:t,onSelectHistoryVersion:this.onSelectHistoryVersion,onShowChanges:this.onShowChanges})]})}}]),t}(a.Component);c.render((0,p.jsx)(W,{}),document.getElementById("wrapper"))},45020:function(){}},function(e){e.O(0,[351],(function(){return n=95558,e(e.s=n);var n}));e.O()}]);
//# sourceMappingURL=sdocFileHistory.01f01c1a.js.map