{% extends base_template %}

{% load seahub_tags avatar_tags i18n %}
{% load url from future %}

{% block extra_style %}
<style type="text/css">
#main { position: relative; }
.go-back { top:6px; }
</style>
{% endblock %}

{% block main_panel %}
    <a href="{{ SITE_ROOT }}repo/history/{{ repo.props.id }}/" class="go-back" title="{% trans "Back to modification history"%}">
        <span class="icon-chevron-left"></span>
    </a>
    <div class="hd">
        <h3 class="fleft">
            <span class=" op-target">{{repo.props.name}}</span> {% trans "snapshot"%}<span class="commit-time">({{ current_commit.props.ctime|tsstr_sec }})</span>
        </h3>
        {% if is_repo_owner %}
        <button data-url="{% url 'seahub.views.repo_history_revert' repo.id %}?commit_id={{ current_commit.id }}" class="repo-revert fright">{% trans "Restore"%}</button>
        {% endif %}
    </div>
    
    <div class="repo-file-list-container">
        {% if path == '/' %}
        <div id="repo-latest-commit">
            <p class="commit-msg">
                <span class="author">
                    {% if current_commit.props.creator_name %}
                    {% avatar current_commit.props.creator_name 20 %}
                    <a class="name" href="{% url 'user_profile' current_commit.props.creator_name %}">{{ current_commit.props.creator_name|email2nickname }}</a>
                    {% else %}
                    {% trans "Unknown"%}
                    {% endif %}
                </span>
                {{ current_commit.props.desc|translate_commit_desc }}
                <span class="time">{{ current_commit.props.ctime|translate_seahub_time }}</span>
            </p>
        </div>
        {% endif %}

        {% if not user_perm %}
        <div class="repo-file-list-not-show">
            <p class="access-notice">{% trans "Can't view this library"%}</p>
        </div>
        {% else %}
        <p class="path">
        {% trans "Current path: "%}
        {% for name, link in zipped %}
        {% if not forloop.last %}
        <a href="{% url 'repo_history_view' repo.id %}?commit_id={{ current_commit.id }}&p={{ link|urlencode }}">{{ name }}</a> /                 
        {% else %}
        {{ name }}
        {% endif %}
        {% endfor %}
        </p>
        <!-- /.repo-file-list-topbar -->
        <table class="repo-file-list">
            <tr>
                <th width="5%"></th>
                <th width="45%">{% trans "Name"%}</th>
                <th width="20%">{% trans "Size"%}</th>
                <th width="30%">{% trans "Operations"%}</th>
            </tr>

            {% for dirent in dir_list %}
            <tr>
                <td class="alc"><img src="{{ MEDIA_URL }}img/folder-icon-24.png" alt="{% trans "Directory"%}" /></td>
                <td><a href="{% url 'repo_history_view' repo.id %}?commit_id={{ current_commit.id }}&p={{ path|urlencode }}{{ dirent.obj_name|urlencode }}">{{ dirent.obj_name }}</a></td>              
                <td></td>
                <td><a class="op vh" href="{% url 'repo_revert_dir' repo.id %}?commit={{ current_commit.id }}&p={{ path|urlencode }}{{dirent.obj_name|urlencode}}&from=repo_history">{% trans "Restore" %}</a></td>
            </tr>
            {% endfor %}

            {% for dirent in file_list %}
            <tr>
                <td class="alc"><img src="{{ MEDIA_URL }}img/file/{{ dirent.obj_name|file_icon_filter }}" alt="{% trans "File"%}" /></td>
                <td><a class="normal" href="{% url 'view_snapshot_file' repo.props.id %}?obj_id={{ dirent.props.obj_id }}&commit_id={{ current_commit.id }}&p={{ path|urlencode }}{{ dirent.obj_name|urlencode }}" target="_blank">{{ dirent.props.obj_name }}</a></td>              
                <td>{{ dirent.file_size|filesizeformat }}</td>
                <td>
                    <a class="op vh" href="{% url 'repo_revert_file' repo.id %}?commit={{ current_commit.id }}&p={{ path|urlencode }}{{dirent.obj_name|urlencode}}&from=repo_history">{% trans "Restore" %}</a>
                    <a class="op vh" href="{% url 'download_file' repo.id dirent.obj_id%}?file_name={{ dirent.obj_name|urlencode }}&p={{path|urlencode}}{{ dirent.obj_name|urlencode }}">{% trans "Download" %}</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        <!-- /.repo-file-list -->
        {% endif %}
    </div>
    {% endblock %}

{% block extra_script %}
<script type="text/javascript">
$('#back').click(function() {
    location.href = $(this).attr('data');
});
addConfirmTo($('.repo-revert'), {
        'title':"{% trans "Restore Library" %}",
        'con':"{% trans "Are you sure you want to restore this library?" %}"
});
</script>
{% endblock %}
