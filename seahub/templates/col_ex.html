<div id="wi-container" class="wi-module" style="max-width: 800px; margin: 20px 0; padding: 20px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0; color: #333;">DeepSeek AI é—®ç­”æ¨¡å—</h3>
    <button id="close-btn" style="padding: 4px 10px; border: none; border-radius: 4px; background: #ff4444; color: white; cursor: pointer; font-size: 12px;">Ã— å…³é—­</button>
  </div>

  <!-- è¾“å…¥åŒºåŸŸï¼ˆPromptï¼‰ -->
  <div id="input-area" style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">AI æé—®ï¼ˆPromptï¼‰ï¼š</label>
    <textarea
      id="ai-prompt-input"
      rows="3"
      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-size: 14px;"
      placeholder="è¯·è¾“å…¥ä½ æƒ³è®©AIå›ç­”çš„é—®é¢˜æˆ–æŒ‡ä»¤..."></textarea>
    <button id="process-btn" style="margin-top: 10px; padding: 8px 16px; border: none; border-radius: 4px; background: #2196F3; color: white; cursor: pointer; font-size: 14px;">
      <span id="process-btn-text">ğŸ¤– ç”Ÿæˆå›ç­”</span>
      <span id="loading-spinner" style="display: none; margin-left: 8px;">â³ ç”Ÿæˆä¸­...</span>
    </button>
  </div>

  <!-- è¾“å‡ºåŒºåŸŸï¼ˆAIå›ç­”ï¼‰ -->
  <div id="output-area" style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">AI å›ç­”ï¼š</label>
    <textarea
      id="ai-answer-output"
      rows="6"
      style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: #f5f5f5; resize: vertical; font-size: 14px;"
      readonly
      placeholder="AIç”Ÿæˆçš„å›ç­”å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
  </div>

  <!-- æäº¤æŒ‰é’®ï¼ˆç¦ç”¨çŠ¶æ€åˆå§‹ï¼‰ -->
  <button id="submit-btn" style="padding: 10px 20px; border: none; border-radius: 4px; background: #cccccc; color: #666; cursor: not-allowed; font-size: 14px;" disabled>
    ğŸš€ æäº¤åˆ°Collabora
  </button>
</div>

<script>
// å…¨å±€é…ç½®
const DEEPSEEK_CONFIG = {
  apiKey: 'sk-bb3d0b5a40d44792a837f51ac3c8fe02', // ä½ çš„DeepSeek API Key
  apiUrl: 'https://api.deepseek.com/v1/chat/completions', // DeepSeek APIåœ°å€
  model: 'deepseek-chat', // ä½¿ç”¨çš„æ¨¡å‹ï¼ˆå¯æ›¿æ¢ä¸ºdeepseek-coderç­‰ï¼‰
};

// å…¨å±€å˜é‡
let coolWindow = null;
let isReady = false;
const container = document.getElementById('wi-container');
const processBtn = document.getElementById('process-btn');
const submitBtn = document.getElementById('submit-btn');
const promptInput = document.getElementById('ai-prompt-input');
const answerOutput = document.getElementById('ai-answer-output');

// åˆå§‹åŒ–ï¼šéšè—æ¨¡å—
container.style.display = 'none';

// ========== äº‹ä»¶ç»‘å®š ==========
// å…³é—­æŒ‰é’®
document.getElementById('close-btn').addEventListener('click', () => {
  container.style.display = 'none';
  resetModule(); // é‡ç½®æ¨¡å—çŠ¶æ€
});

// ç”Ÿæˆå›ç­”æŒ‰é’®
processBtn.addEventListener('click', async () => {
  const prompt = promptInput.value.trim();
  if (!prompt) {
    alert('è¯·è¾“å…¥æé—®å†…å®¹ï¼');
    promptInput.focus();
    return;
  }

  // è®¾ç½®åŠ è½½çŠ¶æ€
  setLoadingState(true);

  try {
    // è°ƒç”¨DeepSeek API
    const answer = await callDeepseekAPI(prompt);
    answerOutput.value = answer;
    submitBtn.disabled = false; // å¯ç”¨æäº¤æŒ‰é’®
    submitBtn.style.background = '#4CAF50';
    submitBtn.style.color = 'white';
    submitBtn.style.cursor = 'pointer';
  } catch (error) {
    alert(`ç”Ÿæˆå¤±è´¥ï¼š${error.message}`);
    console.error('DeepSeek API Error:', error);
  } finally {
    // æ¢å¤æŒ‰é’®çŠ¶æ€
    setLoadingState(false);
  }
});

// æäº¤åˆ°CollaboraæŒ‰é’®
submitBtn.addEventListener('click', () => {
  const answer = answerOutput.value.trim();
  if (!answer) {
    alert('æš‚æ— AIå›ç­”å†…å®¹å¯æäº¤ï¼');
    return;
  }
  submitToCollabora(answer);
});

// ç›‘å¬Collaboraæ¶ˆæ¯
window.addEventListener('message', (e) => {
  const allowedOrigins = [
    'https://office.yourdomain.com',
    'https://collabora.yourdomain.com',
    'https://demo.seatable.cn:6232'
  ];
  if (!allowedOrigins.includes(e.origin)) return;

  let data = {};
  try {
    data = JSON.parse(e.data);
  } catch (err) {
    return;
  }

  // Collaboraå°±ç»ª
  if (data) {
    coolWindow = e.source;
    isReady = true;
    coolWindow.postMessage(JSON.stringify({
      'MessageId': 'Host_PostmessageReady',
      'SendTIme': Date.now(),
      'Values': {}
    }), '*');
  }

  // æ˜¾ç¤ºAIæ¨¡å—
  if (data.MessageId === 'UI_InsertAIContent') {
    container.style.display = 'block';
    promptInput.focus();
    resetModule(); // é‡ç½®çŠ¶æ€
  }
});

// ========== æ ¸å¿ƒå‡½æ•° ==========
/**
 * è°ƒç”¨DeepSeek APIè·å–å›ç­”
 * @param {string} prompt ç”¨æˆ·æé—®
 * @returns {Promise<string>} AIå›ç­”
 */
async function callDeepseekAPI(prompt) {
  const requestBody = {
    model: DEEPSEEK_CONFIG.model,
    messages: [
      { role: 'user', content: prompt }
    ],
    temperature: 0.7, // éšæœºæ€§ï¼ˆ0-1ï¼‰
    max_tokens: 2000, // æœ€å¤§ç”Ÿæˆtokenæ•°
    stream: false // éæµå¼è¾“å‡º
  };

  const response = await fetch(DEEPSEEK_CONFIG.apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${DEEPSEEK_CONFIG.apiKey}`
    },
    body: JSON.stringify(requestBody)
  });

  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥ï¼ˆ${response.status}ï¼‰`);
  }

  const result = await response.json();
  return result.choices[0]?.message?.content || 'AIæœªè¿”å›æœ‰æ•ˆå›ç­”';
}

/**
 * æäº¤å†…å®¹åˆ°Collabora
 * @param {string} content è¦æäº¤çš„å†…å®¹
 */
function submitToCollabora(content) {
  if (!isReady || !coolWindow) {
    alert('Collaboraè¿˜æœªå°±ç»ªï¼Œè¯·ç¨å€™ï¼');
    return;
  }

  coolWindow.postMessage(JSON.stringify({
    'MessageId': 'Action_Paste',
    'Values': {
      'Text': content,
      'Mimetype': 'text/plain;charset=utf-8',
      'Data': content
    }
  }), '*');

  alert('å†…å®¹å·²æˆåŠŸæäº¤åˆ°æ–‡æ¡£ï¼');
  // å¯é€‰ï¼šæäº¤åé‡ç½®æ¨¡å—
  container.style.display = 'none';
  resetModule(); // é‡ç½®æ¨¡å—çŠ¶æ€
}

// ========== å·¥å…·å‡½æ•° ==========
/**
 * è®¾ç½®åŠ è½½çŠ¶æ€
 * @param {boolean} isLoading æ˜¯å¦åŠ è½½ä¸­
 */
function setLoadingState(isLoading) {
  document.getElementById('process-btn-text').style.display = isLoading ? 'none' : 'inline';
  document.getElementById('loading-spinner').style.display = isLoading ? 'inline' : 'none';
  processBtn.disabled = isLoading;
  processBtn.style.opacity = isLoading ? '0.7' : '1';
}

/**
 * é‡ç½®æ¨¡å—çŠ¶æ€
 */
function resetModule() {
  promptInput.value = '';
  answerOutput.value = '';
  submitBtn.disabled = true;
  submitBtn.style.background = '#cccccc';
  submitBtn.style.color = '#666';
  submitBtn.style.cursor = 'not-allowed';
}
</script>