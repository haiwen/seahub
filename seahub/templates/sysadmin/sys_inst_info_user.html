{% extends "sysadmin/sys_inst_info_base.html" %}
{% load i18n seahub_tags %}
{% load staticfiles %}

{% block right_panel %}
<div class="tabnav">
    <ul class="tabnav-tabs">
        <li class="tabnav-tab tabnav-tab-cur"><a href="{% url 'sys_inst_info_users' inst.pk %}">{% trans "Members" %}</a></li>
        <li class="tabnav-tab"><a href="{% url 'sys_inst_info_admins' inst.pk %}">{% trans "Admins" %}</a></li>
    </ul>
    <div class="js-op-for-all fright">
        <button id="add-user-btn">{% trans "Add user" %}</button>
    </div>
</div>

<form id="add-user-form" action="" method="post" class="hide">{% csrf_token %}
    <h3>{% trans "Add user" %}</h3>
    <label for="id_email">{% trans "Email" %}</label><br />
    <input id="id_email" style="width:300px;height:30px;"/>
    <button type="submit" class="submit">{% trans "Submit" %}</button>
    <p id="id_error" class="error hide" style="margin-top:30px;"></p>
</form>
{% if users %}
<table>
    <tr>
        <th width="25%">{% trans "Email" %}</th>
        <th width="10%">{% trans "Status" %}</th>
        <th width="20%">{% trans "Space Used" %}</th>
        <th width="25%">{% trans "Create At / Last Login" %}</th>
        <th width="20%">{% trans "Operations" %}</th>
    </tr>

    {% for user in users %}
    <tr data-userid="{{user.email}}">
        <td><a href="{% url 'user_info' user.email %}">{{ user.email }}</a></td>
        <td>
            <div class="user-status">
              {% if user.is_active %}
                <span class="user-status-cur-value">{% trans "Active" %}</span>
              {% else %}
                <span class="user-status-cur-value">{% trans "Inactive" %}</span>
              {% endif %}
            </div>
        </td>
        <td style="font-size:11px;">
            <p> {{ user.space_usage|seahub_filesizeformat }} {% if user.space_quota > 0 %} / {{ user.space_quota|seahub_filesizeformat }} {% endif %} </p>
        </td>
        <td style="font-size:11px;">
        {{ user.ctime|tsstr_sec }} / {% if user.last_login %}{{user.last_login|translate_seahub_time}} {% else %} -- {% endif %}
        </td>
        <td>
          <a href="#" class="js-toggle-admin op vh" data-url="{% url 'sys_inst_toggle_admin' inst.pk user.email %}" data-target="{{ user.email }}">{% if user.inst_admin %}{% trans "Revoke Admin" %}{% else %}{% trans "Set Admin" %}{% endif %}</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% include "snippets/admin_paginator.html" %}
{% else %}
<p>{% trans "Empty" %}</p>
{% endif %}

<div id="activate-msg" class="hide">
    <p>{% trans "Activating..., please wait" %}</p>
</div>

{% endblock %}

{% block extra_style %}
<link rel="stylesheet" type="text/css" href="{% static "css/select2-3.5.2.css" %}"/>
{% endblock %}
{% block extra_script %}{{ block.super }}
<script type="text/javascript" src= "{% static "scripts/lib/select2-3.5.2.js" %}"></script>

<script type="text/javascript">
addConfirmTo($('.js-toggle-admin'), {
    'title': "Toggle Admin",
    'con': "Sure ?",
    'post': true
});

$('tr:gt(0)').hover(
    function() {
        $(this).find('.user-status-edit-icon').removeClass('vh');
    },
    function() {
        $(this).find('.user-status-edit-icon').addClass('vh');
    }
);
$('.user-status-edit-icon').click(function() {
    $(this).parent().addClass('hide');
    $(this).parent().next().removeClass('hide'); // show 'select'
});
$('#add-user-btn').click(function(){
     $('#add-user-form').modal();
     $('#simplemodal-container').css({'width':'auto', 'height':'auto'});
 
     $("#id_email").select2({
         minimumInputLength: 1,
         maximumSelectionSize:5,
         multiple: true,
         tags: [],
         ajax: {
             url: "{% url 'search-user' %}",
             dataType: 'json',
             delay: 250,
             data: function (term, page) {
                 return {
                     q: term, // search term
                 };
             },
             results: function(data, page){
                 var group_list = [], groups = data.users;
                 for (var i =0, len = groups.length; i < len; i++){
                     group_list.push({
                         "id": i,
                         "email": groups[i].email,
                         "avatar_url": groups[i].avatar_url,
                         "name": groups[i].name
                     });
                 }
                 return {results:group_list};
             }
         },
         formatResult: function(item) {
             var markup = '<li>'+
                 '<div ><img src="' + item.avatar_url + '" width="32" height="32" class="avatar" />'+
                 '<span class="text ellipsis">' + item.name + '<br>' + item.email + '</span></div></li>'
             return markup;
         },
         formatSelection:function(item) {
             return (item.email);
         },
         escapeMarkup: function (m) { return m;  }
     });
 });
 $('#add-user-form').submit(function(){
     var form = $(this),
         data = ""
         form_id = $(this).attr('id'),
         email = $("#id_email").select2("data"),
         submit_btn = $(this).find('[type="submit"]');
     if (!email){
         apply_form_error(form_id, "{% trans "Email can not be blank "%}");
         return false;
     } else {
         for (var i=0; i < email.length; i++){
             data += email[i].email;
             data += ',';
         }
     }
     disable(submit_btn);
     $.ajax({
         url: "{% url 'sys_inst_add_user' inst.id %}",
         type: 'POST',
         dataType: 'json',
         data: {
             'email': data
         },
         beforeSend: prepareCSRFToken,
         success: function(data){
             if(data['success']){
                 location.reload(true);
             }
         },
         error: function(xhr, textStatus, errorThrown){
             if (xhr.responseText) {
                 var error = $.parseJSON(xhr.responseText).error;
                 apply_form_error(form_id, error);
                 enable(submit_btn);
             }
         }
     });
     return false;
 });
 
$('.user-status-select').change(function() {
    var select = $(this),
        select_val = select.val(),
        uid = select.parents('tr').attr('data-userid'),
        url = "{{ SITE_ROOT }}useradmin/toggle_status/" + uid + "/?s=" + select_val;

    $.ajax({
        url: url,
        type: 'GET',
        dataType: 'json',
        cache: false,
        beforeSend: function() {
            if (select_val == 1) {
                // show activating popup
                $('#activate-msg').modal();
                $('#simplemodal-container').css({'height':'auto'});
            }
        },
        success: function(data) {
            if (data['email_sent']) {
                feedback("{% trans "Edit succeeded, an email has been sent." %}", 'success');
            } else if (data['email_sent'] === false) {
                feedback("{% trans "Edit succeeded, but failed to send email, please check your email configuration." %}", 'success');
            } else {
                feedback("{% trans "Edit succeeded" %}", 'success');
            }
            select.prev().children('span').html(select.children('option[value="' +select.val() + '"]').text());
            select.addClass('hide');
            select.prev().removeClass('hide');
            $.modal.close();
        },
        error: function() {
            feedback("{% trans "Edit failed." %}", 'error');
            select.addClass('hide');
            select.prev().removeClass('hide');
            $.modal.close();
        }
    });
});
$(document).click(function(e) {
    var target = e.target || event.srcElement;
    // target can't be edit-icon
    if (!$('.user-status-edit-icon, .user-status-select').is(target)) {
        $('.user-status').removeClass('hide');
        $('.user-status-select').addClass('hide');
    }
});
</script>
{% endblock %}
