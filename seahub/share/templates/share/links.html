{% extends 'home_base.html' %}
{% load seahub_tags i18n %}
{% load url from future %}

{% block sub_title %}{% trans "Links - Share" %} - {% endblock %}

{% block cur_share_links %}tab-cur{% endblock %}

{% block right_panel %}
<div id="tabs" class="tab-tabs">
    <ul class="tab-tabs-nav hd w100 ovhd">
        <li class="tab"><a href="#download-links" class="a">{% trans "Download Links" %}</a></li>
        <li class="tab long-tab"><a href="#upload-links" class="a">{% trans "Upload Links" %}</a></li>
    </ul>
    <div id="download-links">
        {% if fileshares %}
        <table>
            <tr>
                <th width="4%"><!--icon--></th>
                <th class="cspt by-name-down" width="40%">{% trans "Name"%}<span class="icon-caret-up hide"></span></th>
                <th width="24%">{% trans "Library"%}</th>
                <th width="10%">{% trans "Visits"%}</th>
                <th class="cspt by-time-down" width="12%">{% trans "Expiration"%}<span class="icon-caret-up hide"></span></th>
                <th width="10%"><!--Operations--></th>
            </tr>
            {% for fs in fileshares %}
                {% if fs.s_type == 'f' %}
                {% if fs.expire_date %}
                <tr class="file-item" name={{ fs.filename }} data-time={{ fs.expire_date|date:'Y-m-d' }}>
                {% else %}
                <tr class="file-item" name={{ fs.filename }} data-time='--'>
                {% endif %}
                <td class="alc"><img src="{{ MEDIA_URL }}img/file/{{ fs.filename|file_icon_filter }}" alt="{% trans "File"%}" /></td>
                <td><a href="{% url 'view_lib_file' fs.repo.id fs.path|urlencode %}">{{ fs.filename }}</a></td>
                {% else %}
                {% if fs.expire_date %}
                <tr class="dir-item" name={{ fs.filename }} data-time={{ fs.expire_date|date:'Y-m-d' }}>
                {% else %}
                <tr class="dir-item" name={{ fs.filename }} data-time='--'>
                {% endif %}
                <td class="alc"><img src="{{ MEDIA_URL }}img/folder-icon-24.png" alt="{% trans "Directory icon"%}" /></td>
                <td><a href="{% url 'view_common_lib_dir' fs.repo.id fs.path|urlencode|strip_slash %}">{{ fs.filename }}</a></td>
                {% endif %}
                <td><a href="{% url 'view_common_lib_dir' fs.repo.id '' %}">{{ fs.repo.name }}</a></td>
                <td>{{ fs.view_cnt }}</td>
                {% if fs.expire_date %}
                {% if fs.is_expired %}
                <td class='error'>{{ fs.expire_date|date:'Y-m-d' }}</td>
                {% else %}
                <td>{{ fs.expire_date|date:'Y-m-d' }}</td>
                {% endif %}
                {% else %}
                <td>--</td>
                {% endif %}
                <td>
                    <img src="{{ MEDIA_URL }}img/link.png" alt="" class="view-link op-icon vh" data-link="{{ fs.shared_link }}" title="{% trans "View"%}" />
                    <img src="{{ MEDIA_URL }}img/rm.png" alt="" class="rm-link op-icon vh" data-token="{{ fs.token }}" title="{% trans "Remove"%}" />
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <div class="empty-tips">
            <h2 class="alc">{% trans "You don't have any download link"%}</h2>
            <p>{% trans "You can generate a download link for a folder or a file. People receive this link can view the folder or the file online." %}</p>
        </div>
        {% endif %}
    </div>

    <div id="upload-links" class="hide">
        {% if uploadlinks %}
        <table>
            <tr>
                <th width="4%"><!--icon--></th>
                <th width="44%">{% trans "Name"%}</th>
                <th width="25%">{% trans "Library"%}</th>
                <th width="12%">{% trans "Visits"%}</th>
                <th width="15%">{% trans "Operations"%}</th>
            </tr>
            {% for link in uploadlinks %}
            <tr>
                <td class="alc"><img src="{{ MEDIA_URL }}img/folder-icon-24.png" alt="{% trans "Directory icon"%}" /></td>
                <td><a href="{% url 'view_common_lib_dir' link.repo.id link.path|urlencode|strip_slash %}">{{ link.dir_name }}</a></td>
                <td><a href="{% url 'view_common_lib_dir' link.repo.id '' %}">{{ link.repo.name }}</a></td>
                <td>{{ link.view_cnt }}</td>
                <td>
                    <img src="{{ MEDIA_URL }}img/link.png" alt="" class="view-link op-icon vh" data-link="{{ link.shared_link }}" title="{% trans "View"%}" />
                    <img src="{{ MEDIA_URL }}img/rm.png" alt="" class="rm-upload-link op-icon vh" data-token="{{ link.token }}" title="{% trans "Remove"%}" />
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <div class="empty-tips">
            <h2 class="alc">{% trans "You don't have any upload link"%}</h2>
            <p>{% trans "You can generate an upload link from any folder. People receive this link can upload files to this folder." %}</p>
        </div>
        {% endif %}
    </div>
</div>
<input type="text" readonly="readonly" value="" id="shared-link" class="hide" />
{% endblock %}

{% block extra_script %}{{block.super}}
<script type="text/javascript">
{% if fileshares or uploadlinks %}
$(".view-link").click(function() {
    var link = $(this).attr('data-link');
    $('#shared-link').before('<p class="hide">' + link + '</p>')
    .val(link).css('width', $('#shared-link').prev().width() + 2)
    .modal({focus:false});
    $('#shared-link').prev().remove();
});

// rm download/upload link
$('.rm-link, .rm-upload-link').click(function() {
    var _this = $(this);
    $.ajax({
        url: $(this).hasClass('rm-link') ? '{% url 'ajax_remove_shared_link' %}' : '{% url 'ajax_remove_shared_upload_link' %}',
        data: {'t': $(this).attr('data-token')},
        cache: false,
        dataType: 'json',
        success: function() {
            _this.closest('tr').remove();
        },
        error: ajaxErrorHandler
    });
});

$('#shared-link').click(function() {
    $(this).select();
});
//sort by name||time
$('.by-name-down, .by-name-up, .by-time-up, .by-time-down').click(sortLinks);
$('#download-links tr:first span').css({'margin-left': '3px'});
function __toString(str) {
    return str == '--' ? 'seahub' : str;
};
function sortLinks() {
    var th_class = $(this).attr('class').substr(5), by,
    dir_list = [], file_list = [],
    table = $('#download-links table');

    switch (th_class) {
        case 'by-name-down': by = function(a, b) { return a.name.toLowerCase() < b.name.toLowerCase() ? 1 : -1 };break;
        case 'by-name-up': by = function(a, b) { return a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1 };break;
        case 'by-time-up': by = function(a, b) { return __toString(a.time) < __toString(b.time) ? -1 : 1 };break;
        case 'by-time-down': by = function(a, b) { return __toString(a.time) < __toString(b.time) ? 1 : -1 };break;
    }
 
    $('.dir-item').each(function() {
        dir_list.push({'name':$(this).attr('name'), 'time':$(this).data('time'), 'element':this});
    });
    $('.file-item').each(function() {
        file_list.push({'name':$(this).attr('name'), 'time':$(this).data('time'), 'element':this});
    });

    dir_list.sort(by);
    file_list.sort(by);

    $('.dir-item, .file-item').detach();

    $(dir_list).each(function(index, item) {
        table.append(item.element);
    });
    $(file_list).each(function(index, item) {
        table.append(item.element);
    });

    $('tr:first span',table).hide();
    $(this).children('span').show();

    if (th_class.indexOf('time') == -1) {
        if (th_class.indexOf('down') == -1) {
            $(this).removeClass('by-name-up').addClass('by-name-down').children('span').attr('class', 'icon-caret-up');
        } else {
            $(this).removeClass('by-name-down').addClass('by-name-up').children('span').attr('class', 'icon-caret-down');
        }
    } else {
        if (th_class.indexOf('down') == -1) {
            $(this).removeClass('by-time-up').addClass('by-time-down').children('span').attr('class', 'icon-caret-up');
        } else {
            $(this).removeClass('by-time-down').addClass('by-time-up').children('span').attr('class', 'icon-caret-down');
        }
    }
}

{% endif %}
</script>
{% endblock %}
